---
title: "Data Analysis Simulation"
author: "Teresa Del Bianco"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
    toc: yes
  pdf_document:
    toc: yes
    fig_caption: yes 
    includes:  
      in_header: my_header.tex
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

```{r, results='hide'}
packs <- c("dplyr", "ggplot2", "tidyverse", "lmerTest", "nlme", "merTools", "broom.mixed", "car", "knitr", "gridExtra")
lapply(packs, require, character.only = TRUE)
```

# Create a dataset to set up modelling analysis

## Create subject and timepoint levels, and 2 continous variables

```{r}
set.seed(88)  # this will allow you to exactly duplicate your result
Npart = 100
NperTrial = 10
NTP = 5
N = Npart*NperTrial*NTP
subject = factor(rep(1:Npart, each=NperTrial*NTP)) # subject id
TP = factor(rep(seq(1:5), times = NperTrial*NTP)) # timepoint 1-5
ts = rep(seq(1:10), times = NperTrial*NTP) # timestamp 1-10 sec
u = rnorm(Npart, sd=.5)
e = rnorm(N, sd=.25)
x = rnorm(N) # continous variable (predictor)
y = 0.2 + .5*x + u[subject] + e # continous variable (dv)

d = data.frame(subject, TP, x, y)
d = d %>% arrange(TP, subject)
d = data.frame(ts, d)
head(d)
```

## Add sex, age (continous, 1-36) and 1 group with 2 levels

```{r}
set.seed(88)

sg <- data.frame()
sb <- unique(d$subject)

for (i in 1:length(sb)) {
  s = sample(LETTERS[c(6,13)], size = 1)
  g = sample(LETTERS[c(1,2)], size = 1)
  a = sample.int(36, 1, replace = TRUE)
  sg = rbind(sg, cbind(subject=paste(sb[i]), S=s, A=a, G=g))
}

head(sg)
```

```{r}
dg <- d %>%
  left_join(sg, by="subject") %>%
  mutate(AOI="L",
         A=as.numeric(A))
head(dg)
```

# Add AOI

```{r}
dg_2 <- dg %>%
  mutate(y=y+rnorm(n = nrow(dg), mean = 2, sd = 1.35),
         AOI="R")
```

```{r}
dg_all <- rbind(dg, dg_2)
```

# Descriptive Statistics

```{r}
females <- data.frame(dg_all) %>%
  filter(S=="F") %>%
  dplyr::select(subject) %>%
  unique()
females <- females$subject
```
```{r}
descr.means <- dg_all %>%
  mutate(A=as.numeric(A)) %>%
  group_by(TP, G) %>%
  summarise(N=length(unique(subject)),
            N_fem=length(which(unique(subject) %in% females)),
            m.age=round(mean(A), 2),
            min.age=round(min(A), 2),
            max.age=round(max(A), 2),
            m.x=round(mean(x, na.rm=T), 2))
descr.sd <- dg_all %>%
  group_by(TP, G) %>%
  mutate(A=as.numeric(A)) %>%
  summarise(N=length(unique(subject)),
            N_fem=length(which(unique(subject) %in% females)),
            s.age=round(sd(A), 2),
            s.x=round(sd(x, na.rm=T), 2))
descr <- descr.means %>%
  inner_join(descr.sd, by=c("TP", "G", "N", "N_fem")) %>% 
  arrange(G)
```

```{r}
kable(descr, caption = "Table 1: Essential Descriptive Statistics")
```

# Plots

```{r}
AOIS <- unique(dg_all$AOI)
```

## Boxplots

```{r}
av.y.boxplot <- list()

for (i in 1:length(AOIS)) {
  aoi = AOIS[i]
  
  av.y.boxplot[[i]] = dg_all %>%
    filter(AOI==aoi) %>%
    group_by(subject, TP, G, S) %>%
    summarise(m.y=mean(y, na.rm=TRUE)) %>%
    ggplot() +
    geom_boxplot(aes(y=m.y,
             x=as.factor(TP),
             fill=as.factor(TP))) +
    labs(y="Average y",
       x="Visit",
       fill="Visit",
       title=paste0("AOI: ", aoi)) +
    facet_wrap(S~G) +
    theme_bw()
}
```

```{r, fig.align="center", fig.width = 10, fig.height = 8.5, dpi=300, fig.cap="Boxplots of the average DV by visit, G and S collapsed on time across the trial"}
do.call(grid.arrange, av.y.boxplot)
```

# Line plots

```{r}
line.plot <- list()

for (i in 1:length(AOIS)) {
  aoi = AOIS[i]
  
  line.plot[[i]] = dg_all %>%
    filter(AOI==aoi) %>%
    group_by(TP, G, S) %>%
    summarise(M=mean(y, na.rm=TRUE),
            SD=sd(y, na.rm=TRUE)) %>%
    ggplot() +
    geom_errorbar(aes(ymin=M-SD,
                  ymax=M+SD,
                  x=TP,
                  col=G),
                position = position_dodge(0.5)) +
    geom_line(aes(y=M,
             x=TP,
             col=G), 
            position = position_dodge(0.5)) +
    geom_point(aes(y=M,
             x=TP,
             fill=G),
             shape=23,
             size=3,
             position = position_dodge(0.5)) +
    facet_wrap(~S) +
    labs(y="Average y",
       x="Visit",
       title=paste0("AOI: ", aoi)) +
    theme_bw()
}
```

```{r, fig.align="center", fig.width = 10, fig.height = 8.5, dpi=300, fig.cap="Average DV by visit, G and S with relative stanard deviation"}
do.call(grid.arrange, line.plot)
```

# Time-series plots

```{r}
ts.y <- list()

for (i in 1:length(AOIS)) {
  aoi = AOIS[i]
  
  ts.y[[i]] = dg_all %>%
    filter(AOI==aoi) %>%
    ggplot(aes(x=ts, y=y, fill=TP)) + 
    geom_ribbon(stat = "summary", aes(x=ts, group=TP), alpha=0.2) +
    stat_summary(aes(col=TP, group=TP), fun.y = "mean", geom="path") +
    stat_summary(aes(col=TP), fun.y = "mean", geom="point") +
    facet_wrap(S~G) +
    theme_bw() +
    labs(y="Y",
       x="Time (s)",
       col="Visit",
       fill="Visit",
       title=paste0("AOI: ", aoi))  
}
```

```{r, fig.align="center", fig.width = 10, fig.height = 10, dpi=300, fig.cap="Variations of the DV by visit, G and S across the time of the trial"}
do.call(grid.arrange, ts.y)
```

# Correlation plot

```{r}
x.b.group <- list()

for (i in 1:length(AOIS)) {
  aoi = AOIS[i]
  
  x.b.group[[i]] = dg_all %>%
    filter(AOI==aoi) %>%
    group_by(G, A) %>%
    summarise(N=length(y),
            mean = mean(y),
            sd   = sd(y),
            se   = sd / sqrt(N)) %>%
    mutate(A=as.numeric(A)) %>%
    arrange(A) %>%
    ggplot(aes(y=mean, x=A, col=G)) +
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=G), 
              alpha=0.5, position=position_dodge(0.3)) +
    geom_point(position=position_dodge(0.3)) +
    theme_bw() +
    geom_smooth(method = "lm") +
    scale_x_continuous(breaks = c(1,6,9,14,24,36)) +
    labs(y="Agerage y",
       x="Age (months)",
       col="G",
       title=paste0("AOI: ", aoi))  
}
```

```{r, fig.align="center", fig.width = 10, fig.height = 10, dpi=300, fig.cap="Variations of the DV by visit, G and S across the time of the trial"}
do.call(grid.arrange, x.b.group)
```

# Model Selection

## Model A

 * DV: average y
 * Fixed effects: 
    + G, 
    + visit (TP), 
    + S, 
    + AOI,
    + x (covariate)
 * Random effect: visit | id:AOI (longitudinal trend vary over time for each id)

Extensions: 

 * Heterogeneous variance estimate: weight = visit 
 * Autocorrelation: corAR1(form = ~ visit | gender)


```{r}
bm <- lmer(y ~ AOI + (1|subject), data=dg_all)
```

### Test the fixed effects

```{r}
b2 <- lmer(y ~ AOI:TP + (1|subject), data=dg_all)
b3 <- lmer(y ~ AOI:(TP:G) + (1|subject), data=dg_all)
b4 <- lmer(y ~ AOI:(TP:G:S) + (1|subject), data=dg_all)
```

```{r}
m.anv <- anova(bm
               , b2
               , b3
               , b4
               )
m.anv.t <- m.anv %>%
  tidy() %>% 
  mutate_each(funs(round(.,3)), -term)
```

```{r}
kable(m.anv.t, caption = "Table 2: LRT of models vs base model")
```

## Test the random effects

```{r}
b3.1 <- lmer(y ~ AOI:TP:G + (1 + TP | subject:AOI), data=dg_all)
```

```{r}
m.anv <- anova(b3
               , b3.1
               )
m.anv.t <- m.anv %>%
  tidy() %>% 
  mutate_each(funs(round(.,3)), -term)
```

```{r}
kable(m.anv.t, caption = "Table 3: LRT of model vs re model")
```

### Plot Fixed Effects

```{r}
#table here
```

### Plot Random Effect

Simulation from posterior distribution (look better into it):

```{r}
re.sim <- REsim(b3.1) %>%
  separate(groupID, into=c("subject", "AOI"), sep = ":", remove = TRUE) %>%
  mutate(term=ifelse(term=="(Intercept)", paste0("TP", unique(dg_all$TP)[1]), term)) %>%
  dplyr::select(-groupFctr)
```

```{r}
re.sim %>%
  filter(term=="TP1") %>%
  ggplot() +
  geom_hline(yintercept = 0, col="red") +
  geom_pointrange(aes(x=reorder(subject, mean), y=mean, ymin=mean+sd, ymax=mean-sd)) +
  facet_grid(~AOI) +
  theme_bw() +
  theme(axis.text.x = element_blank()) +
  labs(y="Random Effect",
       title=paste0(unique(re.sim$term)))
```

### Plot individual time courses

```{r}
cc <- coef(b3.1)$`subject:AOI`
## variances of fixed effects
fixed.vars <- diag(vcov(b3.1))
## extract variances of conditional modes
r1 <- ranef(b3.1, condVar=TRUE)
cmode.vars <- t(apply(cv <- attr(r1[[1]], "postVar"),3, diag))
seVals <- sqrt(sweep(cmode.vars, 2, fixed.vars, "+"))
res <- cbind(cc[,c(1:5)], seVals)
res2 <- setNames(res,
                 c("TP2","TP3","TP4", "TP5", "TP1", "sd.er.1", "sd.er.2", "sd.er.3", "sd.er.4", "sd.er.5"))
coef.mm <- res2 %>% 
  add_rownames(var = "id:AOI") %>%
  mutate(TP1=TP1+sd.er.1,
         TP2=TP2+sd.er.2,
         TP3=TP3+sd.er.3,
         TP4=TP4+sd.er.4,
         TP5=TP5+sd.er.5)
```
