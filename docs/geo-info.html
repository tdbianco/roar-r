<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Modelling multi-site studies with geographical bias</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Hear me ROAR-R</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Exploring your data
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="propensity-scores.html">Matching Subsamples</a>
    </li>
    <li>
      <a href="geo-info.html">Modelling multi-site data</a>
    </li>
  </ul>
</li>
<li>
  <a href="anova.html">Anova</a>
</li>
<li>
  <a href="lm-assumptions.html">LM</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    LMM
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="lmm-essential-tutorial.html">Essential Tutorial</a>
    </li>
    <li>
      <a href="lmm-contrasts-tutorial.html">Customising Contrasts</a>
    </li>
    <li>
      <a href="lmm-het-var.html">Modelling Heterogeneus Variance</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Modelling multi-site studies with geographical bias</h1>

</div>


<p>We are increasingly working with multi-site studies, which is great, but there is the risk of overlooking systematic differences between geographical sites, that may result in a biased model.</p>
<p>An example could be a different testing environment, and different levels of experience of the staff, depending on the site. If a centre in a certain country comes with decades of experience with a certain technique (such as eye-tracking), we may expect to report slighly more accurate measures compared to a centre where the technique is used for the first time.</p>
<p>Here we present an handy way of assessing bias depending on site, inspired by the methods explained in the HilL&amp;Gelman book “Data Analysis Using Regression and Multilevel/Hierarchical Models” <a href="https://g.co/kgs/zkuYrJ" class="uri">https://g.co/kgs/zkuYrJ</a></p>
<div id="geographic-info" class="section level1">
<h1>Geographic info</h1>
<p>We are going to attach some invented site and outcome info to the lalonde datasent. The example dataframe lalonde contains data of two treatment groups with demographic information. Site info is represented by a factor with 3 levels (centre 1, centre 2…), while outcome is a continous variable with normal distribution.</p>
<pre class="r"><code>set.seed(88) #set seed when generating data
library(arm)
data(lalonde)
lalonde$site &lt;- factor(sample(x = c(1:3), 
                              size = nrow(lalonde), 
                              replace=T))
lalonde$outcome &lt;- rnorm(n = nrow(lalonde), 
                         mean = 0, 
                         sd = 100)
summary(lalonde)</code></pre>
<pre><code>##       age             educ          black             hisp        
##  Min.   :17.00   Min.   : 3.0   Min.   :0.0000   Min.   :0.00000  
##  1st Qu.:20.00   1st Qu.: 9.0   1st Qu.:1.0000   1st Qu.:0.00000  
##  Median :24.00   Median :10.0   Median :1.0000   Median :0.00000  
##  Mean   :25.37   Mean   :10.2   Mean   :0.8337   Mean   :0.08764  
##  3rd Qu.:28.00   3rd Qu.:11.0   3rd Qu.:1.0000   3rd Qu.:0.00000  
##  Max.   :55.00   Max.   :16.0   Max.   :1.0000   Max.   :1.00000  
##     married           nodegr           re74              re75      
##  Min.   :0.0000   Min.   :0.000   Min.   :    0.0   Min.   :    0  
##  1st Qu.:0.0000   1st Qu.:1.000   1st Qu.:    0.0   1st Qu.:    0  
##  Median :0.0000   Median :1.000   Median :    0.0   Median :    0  
##  Mean   :0.1685   Mean   :0.782   Mean   : 2102.3   Mean   : 1377  
##  3rd Qu.:0.0000   3rd Qu.:1.000   3rd Qu.:  824.4   3rd Qu.: 1221  
##  Max.   :1.0000   Max.   :1.000   Max.   :39570.7   Max.   :25142  
##       re78            u74              u75             treat       
##  Min.   :    0   Min.   :0.0000   Min.   :0.0000   Min.   :0.0000  
##  1st Qu.:    0   1st Qu.:0.0000   1st Qu.:0.0000   1st Qu.:0.0000  
##  Median : 3702   Median :1.0000   Median :1.0000   Median :0.0000  
##  Mean   : 5301   Mean   :0.7326   Mean   :0.6494   Mean   :0.4157  
##  3rd Qu.: 8125   3rd Qu.:1.0000   3rd Qu.:1.0000   3rd Qu.:1.0000  
##  Max.   :60308   Max.   :1.0000   Max.   :1.0000   Max.   :1.0000  
##  site       outcome        
##  1:145   Min.   :-309.389  
##  2:150   1st Qu.: -67.830  
##  3:150   Median :   7.287  
##          Mean   :  -1.621  
##          3rd Qu.:  64.275  
##          Max.   : 306.732</code></pre>
<p>We fit a mixed model taking site as a covariante, and allowing random intercept and varying slopes per site (i.e, we obtain individual estimates for each site).</p>
<pre class="r"><code># install.packages(lmerTest)
library(lmerTest)
ml.fit &lt;- lmer(outcome ~ treat + site + (0 + treat | site), data=lalonde)</code></pre>
<pre><code>## boundary (singular) fit: see ?isSingular</code></pre>
<pre class="r"><code>fixef(ml.fit)</code></pre>
<pre><code>## (Intercept)       treat       site2       site3 
##    8.895218   -6.527733  -13.557509   -9.590435</code></pre>
<p>We now make some predictions of the outcome based on our fixed and random effects. This procedure is based on one of the excellent and numerous resources provided by Ben Bolker <a href="https://github.com/bbolker" class="uri">https://github.com/bbolker</a></p>
<pre class="r"><code># create a ds with the essential levels of the predictors; leave the outcome blank to fill it with the predictions
newdat &lt;- expand.grid(
    treat=(c(0,1)),
    site=factor(c(&quot;1&quot;,&quot;2&quot;,&quot;3&quot;)),
    outcome = 0
)

# make predictions
newdat$outcome &lt;- predict(ml.fit,newdat,re.form=NA)

# estimate confidence intervals of the predictions 

mm &lt;- model.matrix(terms(ml.fit),newdat)
pvar1 &lt;- diag(mm %*% tcrossprod(vcov(ml.fit),mm))
tvar1 &lt;- pvar1+VarCorr(ml.fit)$site[1] #adding the site specific variance on the slope
cmult &lt;- 2
newdat &lt;- data.frame(
    newdat
    , plo = newdat$outcome-cmult*sqrt(pvar1)
    , phi = newdat$outcome+cmult*sqrt(pvar1)
    , tlo = newdat$outcome-cmult*sqrt(tvar1)
    , thi = newdat$outcome+cmult*sqrt(tvar1)
)</code></pre>
<p>We summarise the raw data to compare predictions with what happens in real life.</p>
<pre class="r"><code>library(dplyr)
m_ci &lt;- lalonde %&gt;% group_by(site, treat) %&gt;%
  summarise(N=n(),
            m=mean(outcome),
            s=sd(outcome),
            er=qnorm(0.975)*s/sqrt(N),
            upCI=m+er,
            downCI=m-er) %&gt;%
  select(treat, site, m, upCI, downCI) %&gt;% 
  left_join(newdat, by=c(&quot;treat&quot;, &quot;site&quot;)) # here we attach the predictions
head(m_ci)</code></pre>
<pre><code>## # A tibble: 6 x 10
## # Groups:   site [3]
##   treat site       m  upCI downCI outcome    plo   phi    tlo   thi
##   &lt;dbl&gt; &lt;fct&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
## 1     0 1       5.88  26.7  -15.0   8.90   -8.82 26.6   -8.82 26.6 
## 2     1 1       6.52  28.9  -15.8   2.37  -16.8  21.6  -16.8  21.6 
## 3     0 2      -4.00  15.5  -23.5  -4.66  -21.8  12.5  -21.8  12.5 
## 4     1 2     -12.3   11.8  -36.3 -11.2   -30.6   8.21 -30.6   8.21
## 5     0 3       1.62  21.9  -18.7  -0.695 -18.4  17.0  -18.4  17.0 
## 6     1 3     -10.1   15.2  -35.4  -7.22  -25.9  11.5  -25.9  11.5</code></pre>
<p>We now regress the predictions on the actual outcome (how well the actual data do fit the predictions of our model?). We add site in the random effect because we want to investigate how it influeces the deviance between the two.</p>
<pre class="r"><code>reg &lt;- lmer(outcome~m+ (0 + treat | site), data=m_ci)</code></pre>
<pre><code>## boundary (singular) fit: see ?isSingular</code></pre>
<pre class="r"><code>ci &lt;- confint(reg)[3:4,]</code></pre>
<pre><code>## Computing profile confidence intervals ...</code></pre>
<p>And we plot the observed effect of treatment on the predicted effect, together with the slope of the treatment effect.</p>
<pre class="r"><code>library(ggplot2)
g0 &lt;- ggplot(data=subset(m_ci, treat==1), #only take the active treatment subset!
             aes(y=outcome, x=m))+ #and plot actual values on preducted values
  geom_point()
g0 + 
  geom_pointrange(aes(ymin = plo, ymax = phi, col=site)) + # add the prediction interval as an error bar
  geom_abline(aes(intercept=fixef(reg)[1], 
                  slope=fixef(reg)[2])) + # add the slope of the treatment effect
  geom_abline(aes(intercept=ci[1,1], slope=ci[2,1]), 
              linetype=&quot;dashed&quot;, col=&quot;grey&quot;) + # add the confidence intervals of the treatment effect
  geom_abline(aes(intercept=ci[1,2], slope=ci[2,2]), 
              linetype=&quot;dashed&quot;, col=&quot;grey&quot;) +
  labs(x=&quot;Predicted Estimates&quot;, y=&quot;Observed Estimates&quot;)</code></pre>
<p><img src="geo-info_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>We can see here that estimates of site 2 and 3 are quite in line with the treatment effect, as estimated by the model. The most reliable estimate is from site 2 (lies within the confidence interval), meaning that this model captures what is happening at site 2 quite well. However, the behaviour with site 3 is also not that bad, only slighly above the actual effect. However, the estimate of the treatment effect is a bit more underestimated at site 1. This might be a useful information when considering the generalisation to all the sites of the treatment effect.</p>
</div>
<div id="plot-coefficients" class="section level1">
<h1>Plot coefficients</h1>
<p>We may also examine the effect of specific factors depending on the site.</p>
<pre class="r"><code>fit &lt;- lm(outcome ~ age:site + educ:site, data=lalonde)
library(jtools)
plot_coefs(fit, 
           coefs = c(&quot;Age &quot; = &quot;age:site1&quot;, &quot;Education &quot; = &quot;site1:educ&quot;,
                     &quot;Age  &quot; = &quot;age:site2&quot;, &quot;Education  &quot; = &quot;site2:educ&quot;,
                     &quot;Age   &quot; = &quot;age:site3&quot;, &quot;Education   &quot; = &quot;site3:educ&quot;),
           groups = list(&quot;Site 1&quot; = c(&quot;Age &quot;, &quot;Education &quot;), &quot;Site 2&quot; = 
                         c(&quot;Age  &quot;, &quot;Education  &quot;), &quot;Site 3&quot; = c(&quot;Age   &quot;, 
                                                                    &quot;Education   &quot;)),
           inner_ci_level = .90)</code></pre>
<p><img src="geo-info_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>Here we can see that while the effect of education on outcome is positive in all sites, the effect of age is negative in site 2 (even though the CI overlap… probably not a significant difference!).</p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
